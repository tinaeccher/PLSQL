--ranking das vendas de produtos por sabor, do sabor que mais vendeu para o que menos vendeu dentro de um ano específico (o ano será um parâmetro de filtro). 

--MOSTRA A QUANTIDADE DE PRODUTOS COM O SABOR
SELECT TP.SABOR, COUNT(*) AS TOTAL
FROM TINA_TB_PRODUTOS TP
GROUP BY TP.SABOR

-- FAZER UM FILTRO DE SABOR, QTDE DE VENDA E A DATA DA VENDA

SELECT
TP.SABOR,
INF.QUANTIDADE,
NF.DATA_VENDA
FROM TINA_TB_PRODUTOS TP
INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
ON INF.CODIGO_DO_PRODUTO = TP.CODIGO_DO_PRODUTO
INNER JOIN TINA_TB_NOTAS_FISCAIS NF
ON INF.NUMERO = NF.NUMERO

--CONSULTA PELO TOTAL DE VENDAS POR ANO POR SABOOR
SELECT
TP.SABOR,
SUM(INF.QUANTIDADE) AS QTDE_TOTAL, --SOMATÓRIA DA QUANTIDADE
EXTRACT (YEAR FROM NF.DATA_VENDA) AS ANO -- BUSCA TODAS DO ANO COM A FUNÇÃO DE DATA PARA MOSTRAR SOMENTE O ANO
FROM TINA_TB_PRODUTOS TP
INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
ON INF.CODIGO_DO_PRODUTO = TP.CODIGO_DO_PRODUTO
INNER JOIN TINA_TB_NOTAS_FISCAIS NF
ON INF.NUMERO = NF.NUMERO
WHERE EXTRACT (YEAR FROM NF.DATA_VENDA) = 2015 --FILTRA PELA FUNÇÃO DE DATA PARA MOSTRAR SOMENTE O ANO
GROUP BY TP.SABOR, EXTRACT(YEAR FROM NF.DATA_VENDA)--AGRUPA PELA FUNÇÃO DO ANO DA DATA
ORDER BY SUM(INF.QUANTIDADE)

--CONSULTA DO TOTAL GERAL DE VENDAS DO ANO
SELECT TOTAL_ANO.QUANTIDADE_GERAL
FROM (SELECT
      EXTRACT (YEAR FROM NF.DATA_VENDA) AS ANO,
      SUM(INF.QUANTIDADE) AS QUANTIDADE_GERAL
      FROM TINA_TB_NOTAS_FISCAIS NF
      INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
      ON INF.NUMERO = NF.NUMERO
      WHERE EXTRACT (YEAR FROM NF.DATA_VENDA) = 2015
      GROUP BY EXTRACT (YEAR FROM NF.DATA_VENDA)
      ) TOTAL_ANO

--
SELECT --CONSULTA PARA CALCULAR O PERCENTUAL DE VENDAS DE CADA SABOR NO ANO
CONSULTA_RELATORIO.SABOR,
CONSULTA_RELATORIO.ANO,
CONSULTA_RELATORIO.QUANTIDADE_TOTAL,
ROUND((CONSULTA_RELATORIO.QUANTIDADE_TOTAL/CONSULTA_RELATORIO.QUANTIDADE_GERAL)*100,2) --ARRENDONDAMENTO DO PERCENTUAL
AS PERCENTUAL_PARTICIPACAO
FROM (SELECT --CONSULTA PARA MOSTRAR A QUANTIDADE TOTAL POR SABOR NO ANO
      TP.SABOR,
      SUM(INF.QUANTIDADE) AS QUANTIDADE_TOTAL, --SOMATÓRIA DA QUANTIDADE
      EXTRACT (YEAR FROM NF.DATA_VENDA) AS ANO, -- COM A FUNÇÃO DE DATA PARA MOSTRAR SOMENTE O ANO
        (SELECT TOTAL_ANO.QUANTIDADE_GERAL FROM ----INCLUIU A CONSULTA PELA QUANTIDADE GERAL --SOMATORIA DE TUDO
                  (SELECT ----INCLUIU A CONSULTA DO TOTAL GERAL DE VENDAS DO ANO
                   EXTRACT (YEAR FROM NF.DATA_VENDA) AS ANO,
                   SUM(INF.QUANTIDADE) AS QUANTIDADE_GERAL
                   FROM TINA_TB_NOTAS_FISCAIS NF
                   INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
                   ON INF.NUMERO = NF.NUMERO
                   WHERE EXTRACT (YEAR FROM NF.DATA_VENDA) = 2015
                   GROUP BY EXTRACT (YEAR FROM NF.DATA_VENDA)
                   ) TOTAL_ANO
         ) AS QUANTIDADE_GERAL
         FROM TINA_TB_PRODUTOS TP
         INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
         ON INF.CODIGO_DO_PRODUTO = TP.CODIGO_DO_PRODUTO
         INNER JOIN TINA_TB_NOTAS_FISCAIS NF
         ON INF.NUMERO = NF.NUMERO
         WHERE EXTRACT (YEAR FROM NF.DATA_VENDA) = 2015
         GROUP BY TP.SABOR, EXTRACT(YEAR FROM NF.DATA_VENDA)
         ORDER BY SUM(INF.QUANTIDADE) DESC
      )CONSULTA_RELATORIO
      
      
      
      
      
      
--RESOLVIDO---------------------------------------------------------------
SELECT CONSULTA_RELATORIO.SABOR, 
CONSULTA_RELATORIO.ANO,
CONSULTA_RELATORIO.QUANTIDADE_TOTAL,
ROUND((CONSULTA_RELATORIO.QUANTIDADE_TOTAL/CONSULTA_RELATORIO.QUANTIDADE_GERAL)*100,2) AS 
PERCENTUAL_PARTICIPACAO
FROM
      (SELECT TP.SABOR,
      EXTRACT(YEAR FROM NF.DATA_VENDA) AS ANO,
      SUM(INF.QUANTIDADE) AS QUANTIDADE_TOTAL,
            (SELECT TOTAL_ANO.QUANTIDADE_GERAL 
             FROM
                 (SELECT
                 EXTRACT(YEAR FROM NF.DATA_VENDA) AS ANO,
                 SUM(INF.QUANTIDADE) AS QUANTIDADE_GERAL
                 FROM NOTAS_FISCAIS NF
                 INNER JOIN ITENS_NOTAS_FISCAIS INF
                 ON NF.NUMERO = INF.NUMERO
                 WHERE EXTRACT(YEAR FROM NF.DATA_VENDA) = 2016
                 GROUP BY EXTRACT(YEAR FROM NF.DATA_VENDA)
                 ) TOTAL_ANO
             ) AS QUANTIDADE_GERAL
       FROM TABELA_DE_PRODUTOS TP
       INNER JOIN ITENS_NOTAS_FISCAIS INF
       ON TP.CODIGO_DO_PRODUTO = INF.CODIGO_DO_PRODUTO
       INNER JOIN NOTAS_FISCAIS NF
       ON INF.NUMERO = NF.NUMERO
       WHERE EXTRACT(YEAR FROM NF.DATA_VENDA) = 2016
       GROUP BY TP.SABOR,EXTRACT(YEAR FROM NF.DATA_VENDA)
       ORDER BY SUM(INF.QUANTIDADE) DESC
       )CONSULTA_RELATORIO;
