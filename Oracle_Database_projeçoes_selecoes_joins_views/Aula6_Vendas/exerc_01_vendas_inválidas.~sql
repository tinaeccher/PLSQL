-- CALCULAR O VOLUME TOTAL DE COMPRAS POR CLIENTE É VALIDA

SELECT * FROM TINA_TB_CLIENTES

SELECT * FROM NOTAS_FISCAIS

SELECT * FROM TINA_TB_ITENS_NOTAS_FISCAIS

--AO BUSCAR NOTA FISCAL E ITEM DA NOTA
--RETORNA O VALOR TOTAL DE VENDAS POR CLIENTE/CPF

SELECT
NF.CPF, NF.DATA_VENDA, INF.QUANTIDADE
FROM
TINA_TB_NOTAS_FISCAIS NF
INNER JOIN
TINA_TB_ITENS_NOTAS_FISCAIS INF
ON NF.NUMERO = INF.NUMERO

--RETORNA O VALOR TOTAL DE VENDAS POR MÊS
--AGRUPANDO POR DATA - 
--1O CONVERTE COM TO_CHAR 
--SOMATORIA QUANTIDE E GROUP BY POR CPF E FUNCAO

SELECT 
NF.CPF, TO_CHAR(NF.DATA_VENDA, 'MM-YYYY') AS MES_ANO, --CONVERTENDO A DATA PELO MES DO ANO
SUM(INF.QUANTIDADE) AS QUANTIDADE_TOTAL --AGREGANDO OS CAMPOS
FROM TINA_TB_NOTAS_FISCAIS NF
INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
ON NF.NUMERO = INF.NUMERO
GROUP BY --AGRUPAMENTO POR MÊS
CPF, TO_CHAR(NF.DATA_VENDA, 'MM-YYYY');

SELECT CPF, NOME, VOLUME_DE_COMPRA FROM TINA_TB_CLIENTES

--PRIMEIRO COMPARA O VOLUME_DE_COMPRA COM A QUANTIDADE_TOTAL
--UTILIZANDO CASE THEN INDICANDO A CONDIÇÃO INFORMANDO SE VALIDA OU INVALIDA
SELECT 
TC.CPF, TC.NOME, TC.VOLUME_DE_COMPRA, TV.QUANTIDADE_TOTAL,
CASE WHEN TC.VOLUME_DE_COMPRA >= TV.QUANTIDADE_TOTAL THEN 'VENDAS VÁLIDAS'
  ELSE 'VENDAS INVALIDAS' END) AS RESULTADO
FROM TINA_TB_CLIENTES TC
INNER JOIN
      (SELECT 
      NF.CPF, TO_CHAR(NF.DATA_VENDA, 'MM-YYYY') AS MES_ANO, --CONVERTENDO A DATA PELO MES DO ANO
      SUM(INF.QUANTIDADE) AS QUANTIDADE_TOTAL --AGREGANDO OS CAMPOS
      FROM TINA_TB_NOTAS_FISCAIS NF
      INNER JOIN TINA_TB_ITENS_NOTAS_FISCAIS INF
      ON NF.NUMERO = INF.NUMERO
      GROUP BY --AGRUPAMENTO POR MÊS
      CPF, TO_CHAR(NF.DATA_VENDA, 'MM-YYYY')
      )TV
ON TV.CPF = TC.CPF
WHERE TV.MES_ANO = '02-2015'



--EXERCICIO
SELECT
TC.CPF, TC.NOME, TC.VOLUME_DE_COMPRA, TV.MES_ANO, TV.QUANTIDADE_TOTAL,
(CASE WHEN TC.VOLUME_DE_COMPRA >= TV.QUANTIDADE_TOTAL THEN 'VENDAS VÁLIDAS'
ELSE 'VENDAS INVÁLIDAS' END) AS RESULTADO,
ROUND((1 - (TC.VOLUME_DE_COMPRA/TV.QUANTIDADE_TOTAL)) * 100,2)
FROM TINA_TB_CLIENTES TC
INNER JOIN
(SELECT
NF.CPF,
TO_CHAR(NF.DATA_VENDA,'MM-YYYY') AS MES_ANO,
SUM(INF.QUANTIDADE) AS QUANTIDADE_TOTAL
FROM
TINA_TB_NOTAS_FISCAIS NF
INNER JOIN
TINA_TB_ITENS_NOTAS_FISCAIS INF
ON NF.NUMERO = INF.NUMERO
GROUP BY
CPF, TO_CHAR(NF.DATA_VENDA,'MM-YYYY')) TV
ON TV.CPF = TC.CPF
WHERE TV.MES_ANO = '02-2015'
AND (TC.VOLUME_DE_COMPRA - TV.QUANTIDADE_TOTAL) < 0
